name: Zip 3 Files API

on:
  workflow_dispatch:
    inputs:
      content1:
        description: "Contenuto del primo file"
        required: true
      content2:
        description: "Contenuto del secondo file"
        required: true
      content3:
        description: "Contenuto del terzo file"
        required: true
      zipname:
        description: "Nome dello zip finale (senza estensione)"
        required: true
        default: "miozip"

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete old artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching artifacts..."
          artifacts=$(gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[].id')
          for artifact_id in $artifacts; do
            echo "Deleting artifact ID: $artifact_id"
            gh api --method DELETE repos/${{ github.repository }}/actions/artifacts/$artifact_id || true
          done

  build:
    runs-on: ubuntu-latest
    needs: cleanup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Manifest.xml
        run: |
          echo "${{ github.event.inputs.content1 }}" > Manifest.xml

      - name: Create PackageHeader.xml
        run: |
          echo "${{ github.event.inputs.content2 }}" > PackageHeader.xml

      - name: Create Al1PackingPreparationEntity.xml
        run: |
          echo "${{ github.event.inputs.content3 }}" > Al1PackingPreparationEntity.xml

      - name: Debug files
        run: |
          ls -lh
          file Manifest.xml PackageHeader.xml Al1PackingPreparationEntity.xml || true

      - name: Create zip
        run: |
          zip -j "${{ github.event.inputs.zipname }}.zip" \
                 Manifest.xml \
                 PackageHeader.xml \
                 Al1PackingPreparationEntity.xml

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.zipname }}
          path: ${{ github.event.inputs.zipname }}.zip
